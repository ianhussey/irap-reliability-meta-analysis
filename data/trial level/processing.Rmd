---
title: "Data tidying"
author: "Ian Hussey"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

This code is ugly, sorry. The data files for each study were manually processed reshaped in slightly different ways, meaning that slightly different code is needed to tidy each of them. Also, the code to tidy them was written across many years, as my skill improved. So, different methods are employed between datasets to effect the same results, and there is more repetition than there should be. I blame the format of the old IRAP data files for this headache.

```{r, include=FALSE}
knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)
```

```{r}

library(tidyverse)
library(readxl)
library(janitor)

```

# IRAP 2012 VB6 format files

## Evaluative IRAPs

```{r}

wrangle_data <- function(file, n_stimulus_exemplars = 6, timepoint = 1){
  
  temp <- 
    read_csv(file, show_col_types = FALSE) |>
    mutate(participant = as.factor(participant)) |>
    select(-contains("fp_"), -block_order) |>
    mutate_at(vars(starts_with("t")), funs(str_replace(., "Correct", "1"))) |>
    mutate_at(vars(starts_with("t")), funs(str_replace(., "Wrong", "0"))) |>
    mutate_at(vars(starts_with("t")), funs(as.numeric)) |>
    mutate_at(vars(experiment, participant, data_type), as.character) |>
    filter(grepl("Target", data_type)) |>
    right_join(read_csv(file, show_col_types = FALSE) |>
                 mutate(participant = as.factor(participant)) |>
                 select(participant, block_order) |>
                 distinct(participant, .keep_all = TRUE), by = "participant") |>
    mutate(block_order = dplyr::recode(block_order,
                                       "The Consistent-First Sequence was Selected" = "consistent first",
                                       "The Inconsistent-First Sequence was Selected" = "inconsistent first",
                                       "Consistant" = "consistent first",
                                       "Inconsistant" = "inconsistent first")) |>
    mutate(experiment = str_remove(experiment, "[12]"),
           timepoint = timepoint) |>
    # wrangle acc vs rt
    mutate(data_type = str_replace(data_type, "Target ", "target"),
           data_type = str_replace(data_type, "Raw Latency", "rt"),
           data_type = str_remove(data_type, ":"),
         data_type = str_replace(data_type, "Accuracy", "accuracy")) |>
    separate(data_type, into = c("stimulus_number", "data_type"), sep = " ") |>
    # remove rows containing non data
    mutate(exclude = case_when(data_type == "accuracy" &
                                 is.na(t2_c_tt1) &
                                 is.na(t2_c_tt2) &
                                 is.na(t2_c_tt3) &
                                 is.na(t2_c_tt4) &
                                 is.na(t2_ic_tt1) &
                                 is.na(t2_ic_tt2) &
                                 is.na(t2_ic_tt3) &
                                 is.na(t2_ic_tt4) ~ TRUE,
                               data_type == "rt" &
                                 t2_c_tt1 == 0 &
                                 t2_c_tt2 == 0 &
                                 t2_c_tt3 == 0 &
                                 t2_c_tt4 == 0 &
                                 t2_ic_tt1 == 0 &
                                 t2_ic_tt2 == 0 &
                                 t2_ic_tt3 == 0 &
                                 t2_ic_tt4 == 0 ~TRUE,
                               TRUE ~ FALSE)) |>
    filter(exclude == FALSE) |>
    select(-exclude) |>
    # remove redundant rows
    filter(stimulus_number %in% paste0("target", seq(1:n_stimulus_exemplars)))
  
  
  result <- temp |>
    # keep only participants with the correct number of rows
    semi_join(temp |>
                count(participant, timepoint) |>
                filter(n == n_stimulus_exemplars*2),
              by = c("participant", "timepoint")) |>
    select(experiment, participant, timepoint, block_order,
           stimulus_number, data_type, 
           t1_c_tt1, t1_c_tt2, t1_c_tt3, t1_c_tt4, 
           t1_ic_tt1, t1_ic_tt2, t1_ic_tt3, t1_ic_tt4, 
           t2_c_tt1, t2_c_tt2, t2_c_tt3, t2_c_tt4, 
           t2_ic_tt1, t2_ic_tt2, t2_ic_tt3, t2_ic_tt4, 
           t3_c_tt1, t3_c_tt2, t3_c_tt3, t3_c_tt4, 
           t3_ic_tt1, t3_ic_tt2, t3_ic_tt3, t3_ic_tt4) |>
    pivot_longer(cols = starts_with("t1") | starts_with("t2") | starts_with("t3"),
                 names_to = "key",
                 values_to = "value") |>
    pivot_wider(names_from = data_type,
                values_from = value) |>
    separate(key, into = c("block_number", "block_type", "trial_type"), sep = "_") |>
    mutate(block_number = as.numeric(str_remove(block_number, "t")),
           block_type = dplyr::recode(block_type,
                                      "c" = "consistent",
                                      "ic" = "inconsistent")) |>
    # where participant code was missing it appears as 0. so, exclude zeros
    filter(participant != 0)
  
  return(result)
  
}

# temp <- read_csv("raw/IRAP 2012 VB6 format files/chad political attitudes 2016.csv") |>
#   select(-stimuli_category_1) |>
#   right_join(read_csv("raw/IRAP 2012 VB6 format files/chad political attitudes 2016.csv") %>%
#                mutate(participant = as.factor(participant)) %>%
#                select(participant, stimuli_category_1) %>%
#                drop_na() %>%
#                distinct(participant, .keep_all = TRUE), by = "participant") %>%
#   mutate(experiment = case_when(stimuli_category_1 == "Hillary Clinton" ~ "clinton_trump",
#                                 stimuli_category_1 == "man" ~ "men_women",
#                                 stimuli_category_1 == "rich people" ~ "rich_poor"))
# 
# write_csv(temp, "raw/IRAP 2012 VB6 format files/chad political attitudes 2016 fixed experiment.csv")

chad_political_attitudes <- wrangle_data(file = "raw/IRAP 2012 VB6 format files/chad political attitudes 2016.csv")

chad_mental_illness_stigma <- wrangle_data(file = "raw/IRAP 2012 VB6 format files/chad mental illness stigma.csv", 
                                           n_stimulus_exemplars = 8)

chad_bodyImage_IRAP1 <- wrangle_data(file = "raw/IRAP 2012 VB6 format files/chad body image t1.csv", 
                                     timepoint = 1)

chad_bodyImage_IRAP2 <- wrangle_data(file = "raw/IRAP 2012 VB6 format files/chad body image t2.csv", 
                                     timepoint = 2)

chad_gender_IRAP1 <- wrangle_data(file = "raw/IRAP 2012 VB6 format files/chad gender t1.csv",
                                  timepoint = 1)

chad_gender_IRAP2 <- wrangle_data(file = "raw/IRAP 2012 VB6 format files/chad gender t2.csv", 
                                  timepoint = 2)

chad_lincolnHitlerFriendEnemy_IRAP1 <- wrangle_data(file = "raw/IRAP 2012 VB6 format files/chad lincolnHitler FriendEnemy 1.csv", 
                                                    timepoint = 1)

chad_lincolnHitlerFriendEnemy_IRAP2 <- wrangle_data(file = "raw/IRAP 2012 VB6 format files/chad lincolnHitler FriendEnemy 2.csv", 
                                                    timepoint = 2)

chad_lincolnHitlerFriendEnemy_IRAP3 <- wrangle_data(file = "raw/IRAP 2012 VB6 format files/chad lincolnHitler FriendEnemy 3.csv", 
                                                    timepoint = 3)

chad_race_IRAP1 <- wrangle_data(file = "raw/IRAP 2012 VB6 format files/chad race t1.csv", 
                                timepoint = 1)

chad_race_IRAP2 <- wrangle_data(file = "raw/IRAP 2012 VB6 format files/chad race t2.csv", 
                                timepoint = 2)

chad_religion_IRAP1 <- wrangle_data(file = "raw/IRAP 2012 VB6 format files/chad religion t1.csv", 
                                    timepoint = 1)

chad_religion_IRAP2 <- wrangle_data(file = "raw/IRAP 2012 VB6 format files/chad religion t2.csv", 
                                    timepoint = 2)

ian_death <- wrangle_data(file = "raw/IRAP 2012 VB6 format files/ian death.csv") # TODO needs NA blocks excluded

ian_race <- wrangle_data(file = "raw/IRAP 2012 VB6 format files/ian race 2.csv")

```

```{r}

# the lincoln hitler and friend enemy domain needs some bespoke processing
experiment_1 <- read.csv("raw/IRAP 2012 VB6 format files/chad lincolnHitler FriendEnemy 1.csv") |>
  distinct(participant, rule_1) |>
  filter(rule_1 != "") |>
  mutate(experiment = ifelse(str_detect(rule_1, "LINCOLN"), "chad lincolnhitler", "chad friendenemy")) |>
  select(-rule_1)

experiment_2 <- read.csv("raw/IRAP 2012 VB6 format files/chad lincolnHitler FriendEnemy 2.csv") |>
  distinct(participant, rule_1) |>
  filter(rule_1 != "") |>
  mutate(experiment = ifelse(str_detect(rule_1, "LINCOLN"), "chad lincolnhitler", "chad friendenemy")) |>
  select(-rule_1)

experiment_3 <- read.csv("raw/IRAP 2012 VB6 format files/chad lincolnHitler FriendEnemy 3.csv") |>
  distinct(participant, rule_1) |>
  filter(rule_1 != "") |>
  mutate(experiment = ifelse(str_detect(rule_1, "LINCOLN"), "chad lincolnhitler", "chad friendenemy")) |>
  select(-rule_1)

chad_lincolnHitlerFriendEnemy_IRAP1 <- chad_lincolnHitlerFriendEnemy_IRAP1 |>
  select(-experiment) |>
  mutate(participant = as.character(participant)) |>
  left_join(mutate(experiment_1, participant = as.character(participant)), by = "participant")

chad_lincolnHitlerFriendEnemy_IRAP2 <- chad_lincolnHitlerFriendEnemy_IRAP2 |>
  select(-experiment) |>
  mutate(participant = as.character(participant)) |>
  left_join(mutate(experiment_2, participant = as.character(participant)), by = "participant")

chad_lincolnHitlerFriendEnemy_IRAP3 <- chad_lincolnHitlerFriendEnemy_IRAP3 |>
  select(-experiment) |>
  mutate(participant = as.character(participant)) |>
  left_join(mutate(experiment_3, participant = as.character(participant)), by = "participant")


data_lincolnhitler_friendenemy_combinations <- 
  distinct(select(chad_lincolnHitlerFriendEnemy_IRAP1, participant, experiment), participant, .keep_all = TRUE) |>
  full_join(
    distinct(select(chad_lincolnHitlerFriendEnemy_IRAP2, participant, experiment), participant, .keep_all = TRUE),
    by = "participant"
  ) %>%
  full_join(
    distinct(select(chad_lincolnHitlerFriendEnemy_IRAP3, participant, experiment), participant, .keep_all = TRUE),
    by = "participant"
  ) %>%
  mutate(task_1 = dplyr::recode(experiment.x,
                                "chad lincolnhitler_1" = "HITLER",
                                "chad friendenemy_1" = "friend"),
         task_2 = dplyr::recode(experiment.y,
                                "chad lincolnhitler_2" = "HITLER",
                                "chad friendenemy_2" = "friend"),
         task_3 = dplyr::recode(experiment,
                                "chad lincolnhitler_3" = "HITLER",
                                "chad friendenemy_3" = "friend")) %>%
  select(participant, task_1, task_2, task_3) %>%
  mutate(combination = case_when(
    task_1 == task_2 & task_1 == task_3 ~ "all three", 
    task_1 == task_2 ~ "one and two", 
    task_1 == task_3 ~ "one and three", 
    task_2 == task_3 ~ "two and three"
  ))

# # chad provided a list of participants who received faking instructions, check that none were included here. the non overlap observed here demonstrates these were already excluded in manual data processing., 
# faking_instructions <- read_csv("raw/IRAP 2012 VB6 format files/chad friendenemy participants who received faking instructions.csv") %>%
#   mutate(faking_instructions = TRUE,
#          participant = as.character(participant_id)) %>%
#   select(-participant_id) %>%
#   full_join(data_lincolnhitler_friendenemy_combinations, by = "participant")

# logic for assigning IRAPs within-domain timepoints, for test-retest reliability  
chad_lincolnHitlerFriendEnemy_IRAP1 <- chad_lincolnHitlerFriendEnemy_IRAP1 %>%
  mutate(timepoint = 1)

chad_lincolnHitlerFriendEnemy_IRAP2 <- chad_lincolnHitlerFriendEnemy_IRAP2 %>%
  mutate(timepoint = ifelse(participant %in% 
                              pull(filter(data_lincolnhitler_friendenemy_combinations, 
                                          combination %in% c("all three", "one and two")), participant),
                            2, 1))

chad_lincolnHitlerFriendEnemy_IRAP3 <- chad_lincolnHitlerFriendEnemy_IRAP3 %>%
  mutate(timepoint = ifelse(participant %in% 
                              pull(filter(data_lincolnhitler_friendenemy_combinations, 
                                          combination %in% c("one and three", "two and three")), participant),
                            2, 
                            ifelse(participant %in% 
                                     pull(filter(data_lincolnhitler_friendenemy_combinations, 
                                                 combination %in% c("all three")), participant),
                                   NA, 1)))

```

```{r}

# combine
combined_data <- 
  bind_rows(chad_political_attitudes,
            chad_mental_illness_stigma,
            chad_bodyImage_IRAP1,
            chad_bodyImage_IRAP2,
            chad_gender_IRAP1,
            chad_gender_IRAP2,
            chad_lincolnHitlerFriendEnemy_IRAP1,
            chad_lincolnHitlerFriendEnemy_IRAP2,
            chad_lincolnHitlerFriendEnemy_IRAP3,
            chad_race_IRAP1,
            chad_race_IRAP2,
            chad_religion_IRAP1,
            chad_religion_IRAP2,
            ian_death,
            ian_race) |>
  mutate(experiment = str_remove(experiment, "IRAP"),
         experiment = str_remove(experiment, "_1"),
         experiment = str_remove(experiment, "_2"),
         experiment = str_remove(experiment, "_3"),
         experiment = str_remove(experiment, "_")) |>
  mutate(unique_id = paste(experiment, participant, sep = "_")) 

## get demographics data
data_demographics <- read_csv("raw/IRAP 2012 VB6 format files/demographics and performance criteria data.csv") %>%
  select(unique_id, age, gender)
  # many missed cases. haven't tried to hard to match these.
  # missing all data for the following domains: gender, clintontrump, menwomen, richpoor, mentalillness_stigma

data_evalautive_temp <- 
  left_join(combined_data, data_demographics, by = "unique_id")

# filter out participants who do not have the correct number of trials
data_evalautive <- data_evalautive_temp |>
  semi_join(data_evalautive_temp |>
              count(unique_id, timepoint) |>
              filter(n %in% c(144, 192)),
            by = c("unique_id", "timepoint"))

# data_evalautive |>
#   distinct(unique_id, .keep_all = TRUE) |>
#   count(experiment, missing = is.na(age))

```

## Nonevaluative IRAPs

### Multiple domains

```{r}

## process data that was output by/formatted from the VB6 2012+ IRAP
data_input <- bind_rows(read_csv("raw/IRAP 2012 VB6 format files/ian countries 1.csv"),
                        read_csv("raw/IRAP 2012 VB6 format files/ian disgust 2.csv"),
                        read_csv("raw/IRAP 2012 VB6 format files/ian sexuality 2.csv"),
                        read_csv("raw/IRAP 2012 VB6 format files/ian valenced words.csv"),
                        read_csv("raw/IRAP 2012 VB6 format files/ian shapes and colors study 2.csv"),
                        read_csv("raw/IRAP 2012 VB6 format files/ian shapes and colors study 3.csv")) %>%
  mutate(stimulus_number = str_remove_all(trial_and_data_type, " Raw Latency")) %>%
  select(unique_id, participant, experiment, block_order, stimulus_number, trial_and_data_type, 
         tt1_block1_con, tt2_block1_con, tt3_block1_con, tt4_block1_con, 
         tt1_block1_incon, tt2_block1_incon, tt3_block1_incon, tt4_block1_incon, 
         tt1_block2_con, tt2_block2_con, tt3_block2_con, tt4_block2_con, 
         tt1_block2_incon, tt2_block2_incon, tt3_block2_incon, tt4_block2_incon, 
         tt1_block3_con, tt2_block3_con, tt3_block3_con, tt4_block3_con, 
         tt1_block3_incon, tt2_block3_incon, tt3_block3_incon, tt4_block3_incon)

data_completeness <- data_input %>%
  gather(trial_and_block, rt, c("tt1_block1_con", "tt2_block1_con", "tt3_block1_con", "tt4_block1_con", 
                                "tt1_block1_incon", "tt2_block1_incon", "tt3_block1_incon", "tt4_block1_incon", 
                                "tt1_block2_con", "tt2_block2_con", "tt3_block2_con", "tt4_block2_con", 
                                "tt1_block2_incon", "tt2_block2_incon", "tt3_block2_incon", "tt4_block2_incon", 
                                "tt1_block3_con", "tt2_block3_con", "tt3_block3_con", "tt4_block3_con", 
                                "tt1_block3_incon", "tt2_block3_incon", "tt3_block3_incon", "tt4_block3_incon")) %>%
  count(unique_id) %>%
  filter(n %in% c(288, 480)) # methodologically plausible number of trials

data_nonevaluative_rt <- data_input %>%
  semi_join(data_completeness, by = "unique_id") %>%
  filter(str_detect(trial_and_data_type, "Raw Latency")) %>%
  gather(trial_and_block, rt, c("tt1_block1_con", "tt2_block1_con", "tt3_block1_con", "tt4_block1_con", 
                                "tt1_block1_incon", "tt2_block1_incon", "tt3_block1_incon", "tt4_block1_incon", 
                                "tt1_block2_con", "tt2_block2_con", "tt3_block2_con", "tt4_block2_con", 
                                "tt1_block2_incon", "tt2_block2_incon", "tt3_block2_incon", "tt4_block2_incon", 
                                "tt1_block3_con", "tt2_block3_con", "tt3_block3_con", "tt4_block3_con", 
                                "tt1_block3_incon", "tt2_block3_incon", "tt3_block3_incon", "tt4_block3_incon")) %>%
  separate(trial_and_block, into = c("trial_type", "block", "block_type"), sep = "_") %>%
  select(unique_id, block_type, trial_type, stimulus_number, rt, experiment, participant, block_order)

data_nonevaluative_acc <- data_input %>%
  semi_join(data_completeness, by = "unique_id") %>%
  filter(str_detect(trial_and_data_type, "Accuracy")) %>%
  mutate(stimulus_number = str_remove_all(trial_and_data_type, " Accuracy")) %>%
  gather(trial_and_block, accuracy, c("tt1_block1_con", "tt2_block1_con", "tt3_block1_con", "tt4_block1_con", 
                                      "tt1_block1_incon", "tt2_block1_incon", "tt3_block1_incon", "tt4_block1_incon", 
                                      "tt1_block2_con", "tt2_block2_con", "tt3_block2_con", "tt4_block2_con", 
                                      "tt1_block2_incon", "tt2_block2_incon", "tt3_block2_incon", "tt4_block2_incon", 
                                      "tt1_block3_con", "tt2_block3_con", "tt3_block3_con", "tt4_block3_con", 
                                      "tt1_block3_incon", "tt2_block3_incon", "tt3_block3_incon", "tt4_block3_incon")) %>%
  separate(trial_and_block, into = c("trial_type", "block", "block_type"), sep = "_") %>%
  select(unique_id, block_type, trial_type, stimulus_number, experiment, participant, block_order, accuracy)

data_nonevaluative <- data_nonevaluative_rt |>
  bind_cols(data_nonevaluative_acc |> select(accuracy))

```

### Disgust 1

```{r}

data_input_disgust <- read_csv("raw/IRAP 2012 VB6 format files/ian disgust 1.csv") 

data_completeness <- data_input_disgust %>%
  gather(trial_and_block, rt, c("tt1_block1_con", "tt2_block1_con", "tt3_block1_con", "tt4_block1_con", 
                                "tt1_block1_incon", "tt2_block1_incon", "tt3_block1_incon", "tt4_block1_incon", 
                                "tt1_block2_con", "tt2_block2_con", "tt3_block2_con", "tt4_block2_con", 
                                "tt1_block2_incon", "tt2_block2_incon", "tt3_block2_incon", "tt4_block2_incon", 
                                "tt1_block3_con", "tt2_block3_con", "tt3_block3_con", "tt4_block3_con", 
                                "tt1_block3_incon", "tt2_block3_incon", "tt3_block3_incon", "tt4_block3_incon",
                                "tt1_block4_con", "tt2_block4_con", "tt3_block4_con", "tt4_block4_con", 
                                "tt1_block4_incon", "tt2_block4_incon", "tt3_block4_incon", "tt4_block4_incon", 
                                "tt1_block5_con", "tt2_block5_con", "tt3_block5_con", "tt4_block5_con", 
                                "tt1_block5_incon", "tt2_block5_incon", "tt3_block5_incon", "tt4_block5_incon", 
                                "tt1_block6_con", "tt2_block6_con", "tt3_block6_con", "tt4_block6_con", 
                                "tt1_block6_incon", "tt2_block6_incon", "tt3_block6_incon", "tt4_block6_incon")) %>%
  count(unique_id) %>%
  filter(n %in% c(384*2)) # methodologically plausible number of trials

data_disgust_1 <- data_input_disgust %>%
  semi_join(data_completeness, by = "unique_id") %>%
  filter(str_detect(trial_and_data_type, "Raw Latency")) %>%
  gather(trial_and_block, rt, c("tt1_block1_con", "tt2_block1_con", "tt3_block1_con", "tt4_block1_con", 
                                "tt1_block1_incon", "tt2_block1_incon", "tt3_block1_incon", "tt4_block1_incon", 
                                "tt1_block2_con", "tt2_block2_con", "tt3_block2_con", "tt4_block2_con", 
                                "tt1_block2_incon", "tt2_block2_incon", "tt3_block2_incon", "tt4_block2_incon", 
                                "tt1_block3_con", "tt2_block3_con", "tt3_block3_con", "tt4_block3_con", 
                                "tt1_block3_incon", "tt2_block3_incon", "tt3_block3_incon", "tt4_block3_incon",
                                "tt1_block4_con", "tt2_block4_con", "tt3_block4_con", "tt4_block4_con", 
                                "tt1_block4_incon", "tt2_block4_incon", "tt3_block4_incon", "tt4_block4_incon", 
                                "tt1_block5_con", "tt2_block5_con", "tt3_block5_con", "tt4_block5_con", 
                                "tt1_block5_incon", "tt2_block5_incon", "tt3_block5_incon", "tt4_block5_incon", 
                                "tt1_block6_con", "tt2_block6_con", "tt3_block6_con", "tt4_block6_con", 
                                "tt1_block6_incon", "tt2_block6_incon", "tt3_block6_incon", "tt4_block6_incon")) %>%
  separate(trial_and_block, into = c("trial_type", "block", "block_type"), sep = "_") %>%
  mutate(timepoint = ifelse(str_detect(block, "block1") | 
                              str_detect(block, "block2") | 
                              str_detect(block, "block3"), 1, 2),
         experiment = "Disgust (1)") %>%
  select(unique_id, timepoint, block_type, trial_type, rt, experiment, block_order) 

```

### Sexuality 1

```{r}

data_input_sexuality <- read_csv("raw/IRAP 2012 VB6 format files/ian sexuality 1.csv") 

data_completeness <- data_input_sexuality %>%
  gather(trial_and_block, rt, c("tt1_block1_con", "tt2_block1_con", "tt3_block1_con", "tt4_block1_con", 
                                "tt1_block1_incon", "tt2_block1_incon", "tt3_block1_incon", "tt4_block1_incon", 
                                "tt1_block2_con", "tt2_block2_con", "tt3_block2_con", "tt4_block2_con", 
                                "tt1_block2_incon", "tt2_block2_incon", "tt3_block2_incon", "tt4_block2_incon", 
                                "tt1_block3_con", "tt2_block3_con", "tt3_block3_con", "tt4_block3_con", 
                                "tt1_block3_incon", "tt2_block3_incon", "tt3_block3_incon", "tt4_block3_incon")) %>%
  count(unique_id, timepoint) %>%
  filter(n %in% c(480)) # methodologically plausible number of trials

data_sexuality_1 <- data_input_sexuality %>%
  semi_join(data_completeness, by = c("unique_id", "timepoint")) %>%
  filter(str_detect(trial_and_data_type, "Raw Latency")) %>%
  gather(trial_and_block, rt, c("tt1_block1_con", "tt2_block1_con", "tt3_block1_con", "tt4_block1_con", 
                                "tt1_block1_incon", "tt2_block1_incon", "tt3_block1_incon", "tt4_block1_incon", 
                                "tt1_block2_con", "tt2_block2_con", "tt3_block2_con", "tt4_block2_con", 
                                "tt1_block2_incon", "tt2_block2_incon", "tt3_block2_incon", "tt4_block2_incon", 
                                "tt1_block3_con", "tt2_block3_con", "tt3_block3_con", "tt4_block3_con", 
                                "tt1_block3_incon", "tt2_block3_incon", "tt3_block3_incon", "tt4_block3_incon")) %>%
  separate(trial_and_block, into = c("trial_type", "block", "block_type"), sep = "_") %>%
  mutate(test_block = ifelse(str_detect(block, "prac"), FALSE, TRUE),
         experiment = "Sexuality (1)") %>%
  select(unique_id, timepoint, block_type, trial_type, rt, experiment, block_order) 

```

### Personality IRAPs

A late addition from Chad

```{r}

## process data from 2012 IRAP from Chad wave 2
chad_personality_temp <- read_csv("raw/IRAP 2012 VB6 format files/chad personality.csv") %>%
  mutate(participant = as.factor(participant)) %>%
  select(-contains("fp_"), -block_order) %>%
  mutate_at(vars(-experiment, -participant, -data_type, 
                 -stimuli_category_1, -stimuli_category_2, -stimuli_attribute_1, -stimuli_attribute_2), as.character) %>%
  mutate_at(vars(-experiment, -participant, -data_type, 
                 -stimuli_category_1, -stimuli_category_2, -stimuli_attribute_1, -stimuli_attribute_2), as.numeric) %>%
  mutate_at(vars(experiment, participant, data_type, 
                 stimuli_category_1, stimuli_category_2, stimuli_attribute_1, stimuli_attribute_2), as.character) %>%
  filter(grepl("Target", data_type) & grepl("Latency", data_type)) %>%
  right_join(read_csv("raw/IRAP 2012 VB6 format files/chad personality.csv") %>%
               mutate(participant = as.factor(participant)) %>%
               select(participant, block_order) %>%
               distinct(participant, .keep_all = TRUE), by = "participant") %>%
  mutate(block_order = dplyr::recode(block_order,
                                     "The Consistent-First Sequence was Selected" = "Consistent",
                                     "The Inconsistent-First Sequence was Selected" = "Inconsistent",
                                     "Consistant" = "Consistent",
                                     "Inconsistant" = "Inconsistent")) 

# full names were used as participants codes to link data - anonymize
chad_personality_ids <- chad_personality_temp %>%
  distinct(participant) %>%
  rownames_to_column(var = "anonymized_participant")

chad_personality <- chad_personality_temp %>%
  full_join(chad_personality_ids, by = "participant") %>%
  select(-participant) %>%
  rename(participant = anonymized_participant) %>%
  mutate(timepoint = 1,
         unique_id = paste(experiment, participant, sep = "_"),
         stimulus_number = str_remove_all(data_type, " Raw Latency")) %>%
  pivot_longer(cols = starts_with("t1_") | starts_with("t2_") | starts_with("t3_"),
               names_to = "type",
               values_to = "rt") %>%
  separate(type, into = c("blockpair_number", "block_type", "trial_type")) %>%
  select(unique_id, experiment, timepoint, participant, 
         block_order, block_type, trial_type, stimulus_number, rt) %>%
  mutate(block_type = recode(block_type,
                             "ic" = "incon",
                             "c" = "con"))

```

# GO-IRAP format files

```{r}

data_goirap <- 
  bind_rows(
    # read_csv("raw/GO-IRAP format files/ian countries 2 acknowledge.csv") %>%
    #           select(unique_id, 
    #                  experiment,
    #                  gender = participantGender,
    #                  age = participantAge, 
    #                  block_order = startingRule, 
    #                  block_type = currentRule, 
    #                  trial_type = trialType, 
    #                  rt = timeToCorrectResponse,
    #                  accuracy,
    #                  isTestBlock),
    #         read_csv("raw/GO-IRAP format files/ian countries 2 care.csv") %>%
    #           select(unique_id, 
    #                  experiment,
    #                  gender = participantGender,
    #                  age = participantAge, 
    #                  block_order = startingRule, 
    #                  block_type = currentRule, 
    #                  trial_type = trialType, 
    #                  rt = timeToCorrectResponse,
    #                  accuracy,
    #                  isTestBlock),
    read_csv("raw/GO-IRAP format files/ian shapes and colors 1 YNrule.csv") %>%
      select(unique_id, 
             experiment,
             gender = participantGender,
             age = participantAge, 
             block_order = startingRule, 
             block_type = currentRule, 
             trial_type = trialType, 
             rt = timeToCorrectResponse,
             accuracy,
             isTestBlock),
    read_csv("raw/GO-IRAP format files/ian shapes and colors 2 YNcorrect.csv") %>%
      select(unique_id, 
             experiment,
             gender = participantGender,
             age = participantAge, 
             block_order = startingRule, 
             block_type = currentRule, 
             trial_type = trialType, 
             rt = timeToCorrectResponse,
             accuracy,
             isTestBlock),
    read_csv("raw/GO-IRAP format files/ian shapes and colors 3 TFcorrect.csv") %>%
      select(unique_id, 
             experiment,
             gender = participantGender,
             age = participantAge, 
             block_order = startingRule, 
             block_type = currentRule, 
             trial_type = trialType, 
             rt = timeToCorrectResponse,
             accuracy,
             isTestBlock),
    read_csv("raw/GO-IRAP format files/ian shapes and colors 4 TFrule.csv") %>%
      select(unique_id, 
             experiment,
             gender = participantGender,
             age = participantAge, 
             block_order = startingRule, 
             block_type = currentRule, 
             trial_type = trialType, 
             rt = timeToCorrectResponse,
             accuracy,
             isTestBlock),
  ) %>%
  filter(isTestBlock == 1) %>%
  select(-isTestBlock) %>%
  mutate(block_type = dplyr::recode(block_type,
                                    `1` = "con",
                                    `2` = "incon"),
         block_order = dplyr::recode(block_order,
                                     `1` = "con",
                                     `2` = "incon"),
         trial_type = dplyr::recode(trial_type,
                                    `1` = "tt1",
                                    `2` = "tt2",
                                    `3` = "tt3",
                                    `4` = "tt4"))

```

# Combine

```{r}

data_trial_level_temp <- 
  bind_rows(data_evalautive,
            data_nonevaluative,
            data_disgust_1,
            data_sexuality_1,
            chad_personality,
            data_goirap) %>%
  select(-accuracy) %>%  # available for only a subset of IRAPs
  # if no timepoint, then timepoint = 1
  mutate(timepoint = ifelse(is.na(timepoint), 1, timepoint),
         timepoint = ifelse(timepoint == 1, "baseline", 
                            ifelse(timepoint == 2, "followup", timepoint)),
         block_order = ifelse(str_detect(tolower(block_order), "incon"), "incon",
                              ifelse(str_detect(tolower(block_order), "con"), "con", NA))) %>%
  rename(domain = experiment) %>%
  mutate(domain = dplyr::recode(domain,
                                "clintontrump" = "Clinton-Trump",				
                                "menwomen" = "Gender (2)",				
                                "richpoor" = "Rich-Poor",
                                "ADHD" = "Stigma - ADHD",				
                                "PTSD" = "Stigma - PTSD",				
                                "schizophrenia" = "Stigma - Schizophrenia",
                                "agreeableness" = "Personality - Agreeableness",
                                "conscientiousness" = "Personality - Conscientiousness",
                                "extraversion" = "Personality - Extraversion",
                                "neuroticism" = "Personality - Neuroticism",
                                "openness" = "Personality - Openness",
                                "chad bodyimage" = "Body image",
                                "chad friendenemy" = "Friend-Enemy",
                                "chad gender" = "Gender (1)",
                                "chad lincolnhitler" = "Lincoln-Hitler",
                                "chad race"	 = "Race (1)",
                                "ian race" = "Race (2)",
                                "chad religion" = "Religion",
                                "ian death emma" = "Death (1)",
                                "ian death june" = "Death (2)",
                                "ian death tarah" = "Death (3)",
                                "Disgust (1)" = "Disgust (1)",
                                "Disgust (2)" = "Disgust (2)",
                                "Sexuality (1)" = "Sexuality (1)",
                                "Sexuality (2)" = "Sexuality (2)",
                                "countries acknowledge 1" = "Countries (1)",
                                "countries care 1" = "Countries (2)",
                                "countries 2 acknowledge" = "Countries (3)",
                                "countries 2 care" = "Countries (4)",
                                "valenced words" = "Valenced words",
                                "shapes and colors 1 yesno fullrule" = "Shapes & colors (1)",
                                "shapes and colors 2 yesno respondcorrectly" = "Shapes & colors (2)",
                                "shapes and colors 3 truefalse respondcorrectly" = "Shapes & colors (3)",
                                "shapes and colors 4 truefalse fullrule" = "Shapes & colors (4)",
                                "shapes and colors exp 2 full rule" = "Shapes & colors (5)",
                                "shapes and colors exp 2 minimal rule" = "Shapes & colors (6)",
                                "shapes and colors exp 3" = "Shapes & colors (7)")) %>%
  arrange(as.character(domain)) %>%
  # calculate mean rt
  group_by(unique_id, timepoint) %>%
  mutate(mean_rt = round(mean(rt, na.rm = TRUE), 0)) %>%
  ungroup() %>%
  # mark odd vs even trials
  group_by(unique_id, timepoint) %>%
  mutate(row_id = row_number()) %>%
  ungroup() %>%
  mutate(trial_odd_even = ifelse(row_id %% 2 == 1, "odd", "even")) %>%
  select(unique_id, 
         #participant, 
         age, gender, domain, timepoint, 
         # stimulus_number
         block_order, block_type, trial_odd_even, trial_type, rt, mean_rt) %>%
  # tidy unique_ids
  mutate(domain = str_remove(domain, "_clinton_trump"),
         domain = str_remove(domain, "_men_women"),
         domain = str_remove(domain, "_rich_poor"),
         domain = str_remove(domain, "_ADHD"),
         domain = str_remove(domain, "_schizophrenia"),
         domain = str_remove(domain, "_PTSD"))

# do exclusions for unique ids with wrong number of trials
data_correct_n_trials <- data_trial_level_temp %>%
  count(unique_id, timepoint) %>%
  # methodologically plausible number of trials
  filter(n %in% c(144, 192, 240, 288, 384)) 

data_trial_level_temp2 <- semi_join(data_trial_level_temp, data_correct_n_trials, by = c("unique_id", "timepoint"))

# task parameters
data_task_parameters <- read_excel("../../measures/word stimuli and task parameters.xlsx") %>%
  clean_names() %>%
  select(domain, trials_per_block, number_of_pairs_of_test_blocks, response_option_locations)

data_trial_level <- data_trial_level_temp2 %>%
  left_join(data_task_parameters, by = "domain")

# write to disk
write_csv(data_trial_level, "data_trial_level.csv")

```

# Session info

```{r}

sessionInfo()

```


